## 7. Django ì›¹ í˜ì´ì§€ êµ¬í˜„ ì›ë¦¬ ì •ë¦¬

\1.      Views.py :  ì›¹ í˜ì´ì§€ì— ì¶œë ¥í•  ê²ƒë“¤ í•¨ìˆ˜ë¡œ ë§Œë“œëŠ” ê³³

\2.      Urls.py :  views.pyì—ì„œ ë§Œë“  í•¨ìˆ˜ë“¤ì´ ì—°ê²°ë  í˜ì´ì§€ ì£¼ì†Œ ë§Œë“œëŠ” ê³³

\3.      Html : ê° í˜ì´ì§€ ì¶œë ¥ ë° ë””ìì¸ ì„¤ì •

\4.      Models.py  : sqlite3ì™€ ì—°ê²°í•  DB class ìƒì„±í•˜ëŠ”  ê³³

\5.      Admin.py :  adminì— 4ì—ì„œ ë§Œë“  ê²ƒ ë“±ë¡

\6.      Setting.py  : ê°ì¢… setting 

 

 

**1.****ì‹œì‘ í˜ì´ì§€**

**1)views.py**

def index(request):

â€‹           return  render(request, 'posts/index.html')

 

**2)urls.py**

path('start/', views.index)

 

**3)index.html**

 

**2.****ì‚¬ì§„ ì—…ë¡œë“œ í˜ì´ì§€**

**1)views.py**

class CreatePostView(CreateView): 

â€‹     model = Post

â€‹     form_class = PostForm

â€‹     template_name = 'posts/post.html'

â€‹     success_url = reverse_lazy('result')

 

**2)urls.py**  

path('start/post/',  CreatePostView.as_view(), name='add_post')

 

**3)post.html**

 

**3.OCR** **ê²°ê³¼ í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ ë„ìš°ëŠ” í˜ì´ì§€**

**1)views.py**

def index01(request):

â€‹           image  = Post.objects.all()

â€‹           key  = Post.objects.all() 

â€‹           image_db01=key[len(key)-1].cover  

â€‹           image_db=str(image_db01)

â€‹           client  = vision.ImageAnnotatorClient() 

â€‹           file_name  = os.path.join(

â€‹                   os.path.dirname('C:'), '/project/uploading/media/'  + image_db)

 

â€‹           with  io.open(file_name, 'rb') as image_file:

â€‹                      content  = image_file.read()

 

â€‹           image  = types.Image(content=content)

â€‹           response  = client.text_detection(image=image)

â€‹           texts  = response.text_annotations

â€‹        

â€‹           my_list  = list()

â€‹           for  text in texts:

â€‹                      result  = text.description

â€‹                      my_list.append(result)

â€‹               

â€‹           data = my_list[0]

â€‹           data1 = data.replace('\n',' ')

â€‹           data2 = data1.replace('(',' ')

â€‹           data3 = data2.replace(')',' ')

â€‹           data4 = data3.replace('/',' ')

â€‹           data4 = data3.replace('ê·¸ë¼ë‹ˆë•Œ','ê·¸ë¼ë‹ˆë”°')

â€‹           data4 = data3.replace('Sparkling','ìŠ¤íŒŒí´ë§')

â€‹           data5 = data4.split(' ')

â€‹           df = pd.DataFrame(data5,  columns=["ì´ë¦¬ìŠ¤íŠ¸"])

â€‹           df1 =  pd.DataFrame(columns=["0","1","2","3"])

â€‹           df2 =  pd.DataFrame(columns=["0","1","2","3"])

 

â€‹           df1.loc[0, '3'] ="ì•„ë©”ë¦¬ì¹´ë…¸"

â€‹           df1.loc[1, '2'] ="ì•„ì´ìŠ¤"

â€‹           â€¦â€¦.

df1.loc[116,'2']="ì²­í¬ë„"

df1.loc[116,'3']="Sparkling"

â€‹           menu=df1[['0','1','2','3']].astype(str).sum(axis=1)

â€‹           menu  = menu.str.replace('nan', '')

â€‹           m2=menu.unique()

â€‹           Allmenu  = pd.DataFrame(m2, columns = ["AllMenu"])

 

â€‹           for  i in range(0,len(df.index)):

â€‹                      for  i2 in range(0,len(df1.index)):

â€‹                                 if  df1.loc[i2,'0'] == df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]:

â€‹                                             df2.loc[i2,'0']  = df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]

â€‹                                 elif  df1.loc[i2,'1'] == df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]:

â€‹                                             df2.loc[i2,'1']  = df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]

â€‹                                 elif  df1.loc[i2,'2'] == df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]:

â€‹                                             df2.loc[i2,'2']  = df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]

â€‹                                 elif  df1.loc[i2,'3'] == df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]:

â€‹                                             df2.loc[i2,'3']  = df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]

â€‹           

â€‹           df3=df2.sort_index()

â€‹           match=df3[['0','1','2','3']].astype(str).sum(axis=1)  

â€‹           match  = match.str.replace('nan', '') 

â€‹           match  = match.unique() 

â€‹           imgtxt  = pd.DataFrame(match, columns = ["imgtxt"])

 

â€‹           results  = list()

â€‹           for  s1 in m2:

â€‹                      for  s2 in match:

â€‹                                 if  s1 == s2:

â€‹                                             results.append(s1)

â€‹           context  = {'texts' : results}

\# index2.html ì°½ì—ì„œ {{texts}}ë¡œ ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸°

â€‹           return  render(request, 'posts/index2.html', context)

 

**2)urls.py**

path('start/post/result/', views.index01,  name = 'result'),

 

**3)index2.html**

 

**4)models.py  ( sqllite3ì™€ ì—°ë™ë˜ëŠ” DB ìƒì„±í•˜ê¸° ) (  admin ë“±ë¡ì€ admin.pyì—ì„œ)**

from django.db import models

class Post(models.Model):

â€‹     cover = models.ImageField(upload_to='images/')

 

ğŸ¡º python manage.py createsuperuser  # admin ê³„ì • ìƒì„±          

ğŸ¡º python manage.py makemigrations  # DB ìƒì„±

ğŸ¡º python manage.py migrate # DB ì—°ê²°

 

 

 

**4.****ìµœì¢… ê²°ê³¼ ( ì¶”ì²œë©”ë‰´ ë° 5ìˆœìœ„  ë©”ë‰´ ), 1ìˆœìœ„ ë©”ë‰´ ì ìˆ˜ / ë‚ ì”¨ ( ë§‘ì€ ë‚ , ë¹„ ì˜¤ëŠ” ë‚  ) /  ì˜¤ëŠ˜ ë‚ ì§œ** 

**1)views.py**

def index02(request):

â€‹           image  = Post.objects.all()

â€‹           key  = Post.objects.all() 

â€‹           image_db01=key[len(key)-1].cover  

â€‹           image_db=str(image_db01)

â€‹           client  = vision.ImageAnnotatorClient()   

â€‹           file_name  = os.path.join( os.path.dirname('C:'),   '/project/uploading/media/' + image_db)

with  io.open(file_name, 'rb') as image_file:

â€‹                      content  = image_file.read()

image =  types.Image(content=content)

â€‹           response  = client.text_detection(image=image)

â€‹           texts  = response.text_annotations

â€‹                  

â€‹           my_list  = list()

â€‹           for  text in texts:

â€‹                      result  = text.description

â€‹                      my_list.append(result)

â€‹               

â€‹           data  = my_list[0]

â€‹           data1  = data.replace('\n',' ')

â€‹           data2  = data1.replace('(',' ')

â€‹           data3  = data2.replace(')',' ')

â€‹           data4  = data3.replace('/',' ')

â€‹           data4  = data3.replace('ê·¸ë¼ë‹ˆë•Œ','ê·¸ë¼ë‹ˆë”°')

â€‹           data4  = data3.replace('Sparkling','ìŠ¤íŒŒí´ë§')

â€‹           data5  = data4.split(' ')

â€‹           df  = pd.DataFrame(data5, columns=["ì´ë¦¬ìŠ¤íŠ¸"])

â€‹           df1  =  pd.DataFrame(columns=["0","1","2","3"])

â€‹           df2  =  pd.DataFrame(columns=["0","1","2","3"])

 

â€‹           df1.loc[0, '3'] ="ì•„ë©”ë¦¬ì¹´ë…¸"

â€‹           df1.loc[1, '2'] ="ì•„ì´ìŠ¤"

â€‹           â€¦â€¦.

df1.loc[116,'2']="ì²­í¬ë„"

df1.loc[116,'3']="Sparkling"

 

â€‹           menu=df1[['0','1','2','3']].astype(str).sum(axis=1)

â€‹           menu  = menu.str.replace('nan', '')

â€‹           m2=menu.unique()

â€‹           Allmenu  = pd.DataFrame(m2, columns = ["AllMenu"])

 

â€‹           for  i in range(0,len(df.index)):

â€‹                      for  i2 in range(0,len(df1.index)):

â€‹                                 if  df1.loc[i2,'0'] == df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]:

â€‹                                             df2.loc[i2,'0']  = df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]

â€‹                                 elif  df1.loc[i2,'1'] == df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]:

â€‹                                             df2.loc[i2,'1']  = df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]

â€‹                                 elif  df1.loc[i2,'2'] == df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]:

â€‹                                             df2.loc[i2,'2']  = df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]

â€‹                                 elif  df1.loc[i2,'3'] == df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]:

â€‹                                             df2.loc[i2,'3']  = df.loc[i,"ì´ë¦¬ìŠ¤íŠ¸"]

â€‹           

â€‹           df3=df2.sort_index()

â€‹           match=df3[['0','1','2','3']].astype(str).sum(axis=1)  

â€‹           match  = match.str.replace('nan', '') 

â€‹           match  = match.unique() 

â€‹           imgtxt  = pd.DataFrame(match, columns = ["imgtxt"])

 

 

**# ê¸°ìƒì²­ APIë¡œ í˜„ì¬ ë‚ ì”¨( í•œ ì‹œê°„ ì „ ) ë¹„ ì—¬ë¶€  ë¶ˆëŸ¬ì˜¤ê¸°**

â€‹           year  = datetime.now().year

â€‹           month  = datetime.now().month

â€‹           if  month < 10:

â€‹                      month  = '0' + str(month)

â€‹           day  = datetime.now().day

â€‹           if  day < 10:

â€‹                      day  ='0' + str(day)

â€‹           hour  = datetime.now().hour-1 # 1ì‹œê°„ ì „ ë‚ ì”¨ë¥¼ ë¶ˆëŸ¬ì˜´. 

â€‹           if  hour < 10:

â€‹                      hour  = '0' + str(hour)

â€‹           minute  = datetime.now().minute

â€‹           if  minute < 10:

â€‹                      minute  = '0' + str(minute)

â€‹           time_number  = str(hour)+str(minute)

 

â€‹    **#api** **í˜¸ì¶œ #60-127 ì„œìš¸ì‹œ**

â€‹           url  = 'http://newsky2.kma.go.kr/service/SecndSrtpdFrcstInfoService2/ForecastGrib'

â€‹           queryParams = '?' +  urlencode({quote_plus('ServiceKey'):  'vNTq1lksHC5gAxJtE2JHfHXFsESjQxUWA7TJyvVUvX3wHAmgc9UDnLIPz94tPZRfidRUEd9Mm8fCOl4rHoakUw==',  

â€‹                                   quote_plus('base_date') :  str(year)+str(month)+str(day), 

â€‹                                    quote_plus('base_time') : str(time_number), 

â€‹                                    quote_plus('nx') : '60', 

â€‹                                   quote_plus('ny')  : '127',  #60-127 ì„œìš¸ì‹œ

â€‹                                    quote_plus('numOfRows') : '10', 

â€‹                                    quote_plus('pageNo') : '1', 

â€‹                                    quote_plus('_type') : 'json' })

 

â€‹           request1  = Request(url + queryParams)

â€‹           request1.get_method  = lambda: 'GET'

â€‹           response_body  = urlopen(request1).read()

 

â€‹    **#json type****ìœ¼ë¡œ ë³€í˜•**

â€‹           my_json  = response_body.decode('utf8').replace("'", '"')

â€‹           Weather  = json.loads(my_json)

â€‹           Weather

â€‹    **#****ì¹´í…Œê³ ë¦¬ í™•ì¸ìš© PYT = ê°•ìˆ˜ ì—¬ë¶€**

â€‹           C  =  Weather["response"]["body"]["items"]["item"][0]["category"]

â€‹    **#****ë‚ ì”¨ ê°’ #pyt = ê°•ìˆ˜ í˜•íƒœ 0=ë§‘ìŒ, 1 ë¹„, 2 ëˆˆë¹„, 3 ëˆˆ**

â€‹           R  =  Weather["response"]["body"]["items"]["item"][0]["obsrValue"]

 

â€‹           if  R == 3:

â€‹                      R  = 0 # ëˆˆ-> ë¹„ê°€ ì•ˆì˜¨ ë‚  0

â€‹           if  R == 2:

â€‹                      R  = 1 # ì§„ëˆˆê¹¨ë¹„ -> ë¹„ì˜¨ë‚  1

 

â€‹    **#****ê°•ìˆ˜ ì—¬ë¶€ì˜ ê°’ì´ ì•„ë‹ ê²½ìš° Errorê°€ ëœ¨ë„ë¡ ì„¤ì •.**  

â€‹           if  C != 'PTY':

â€‹                      C  = 'Error'

â€‹           if  C == 'Error':

â€‹                      R  = 'Error'

â€‹           con  = cx_Oracle.connect("dator/me@localhost:1521/XE")

â€‹           cur=con.cursor()

â€‹           

if R == 0:

â€‹                      cur.execute("SELECT  menu FROM data_no_rain ORDER BY NoRainResult DESC")

â€‹           else:

â€‹                      cur.execute("SELECT  menu FROM data_rain ORDER BY RainResult DESC")

â€‹           

â€‹           stt=()

â€‹           sttdf  = pd.DataFrame(columns=["ìˆœìœ„ë©”ë‰´"])

â€‹           i6=0

 

â€‹           for  row in cur:

â€‹                      stt+=row

â€‹                      sttdf.loc[i6,"ìˆœìœ„ë©”ë‰´"]=stt[i6]

â€‹                      i6+=1

 

â€‹           result_finish  = pd.DataFrame(columns=["ìµœì¢…ê²°ê³¼","ìˆœìœ„"])

â€‹           for  i7 in range(0,len(imgtxt.index)):

â€‹                      for  i8 in range(0,len(sttdf.index)):

â€‹                                 if  sttdf.loc[i8,'ìˆœìœ„ë©”ë‰´'] ==  imgtxt.loc[i7,"imgtxt"]:

â€‹                                             result_finish.loc[i8,'ìµœì¢…ê²°ê³¼'] = imgtxt.loc[i7,"imgtxt"]

â€‹                                             result_finish.loc[i8,'ìˆœìœ„']=i8

 

â€‹           result_finish01=result_finish.sort_index()

â€‹           final=result_finish01.iloc[0,0]

â€‹           flist  = list()

â€‹           for  i9 in range(0,2):

â€‹                      final2  = result_finish01.iloc[i9,0]

â€‹                      flist.append(final2)

â€‹           if  R == 0:

â€‹                      a  = "ë§‘ì€ ë‚ "

â€‹           else:

â€‹                      a  = "ë¹„ ì˜¤ëŠ” ë‚ "

 

â€‹           today  = date.today().strftime('%Y-%m-%d')

 

â€‹           info  = cur.execute("SELECT * FROM info5")   

â€‹           rows  = cur.fetchall()

â€‹           df1  = pd.DataFrame(rows, columns =["ë©”ë‰´","ë§›í‰ê°€","ì–‘í‰ê°€","ë¦¬ë·°","ë¹ˆë„ìˆ˜"] )

â€‹           df1["ë¹ˆë„ìˆ˜"]=df1["ë¹ˆë„ìˆ˜"].astype(int)

â€‹           qq=str(final)

 

â€‹           for  z in range(0, len(df1)):

â€‹                      if  df1.loc[z,"ë©”ë‰´"] == qq:

â€‹                                 aa  = df1.loc[z]

â€‹           dict1 = "ë©”ë‰´: {} ë§›í‰ê°€: {}, ì–‘í‰ê°€:  {}, ë¦¬ë·°: {}, ë¹ˆë„ìˆ˜:{}".format(aa[0],  aa[1] ,aa[2], aa[3], aa[4])

â€‹           context  = {'recommend' : final, 'final2' : flist, 'weather': a,  'date':today,'info':dict1 }

â€‹           return  render(request, 'posts/index3.html', context)

 

**2)urls.py**

path('start/post/result/result1/',  views.index02)

 

**3)index3.html**

![img](file:///C:/Users/ê¹€ë€ì•„/AppData/Local/Temp/msohtmlclip1/01/clip_image002.gif)

![img](file:///C:/Users/ê¹€ë€ì•„/AppData/Local/Temp/msohtmlclip1/01/clip_image004.gif)

![img](file:///C:/Users/ê¹€ë€ì•„/AppData/Local/Temp/msohtmlclip1/01/clip_image006.gif)